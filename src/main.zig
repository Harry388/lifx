const std = @import("std");
const socket = @import("socket.zig");

const Action = enum {
    on,
    off,

    fn fromString(action: []const u8) ?Action {
        return if (stringEquals(action, "on"))
            .on
        else if (stringEquals(action, "off"))
            .off
        else
            null;
    }
};

pub fn main() !void {
    var args = std.process.args();
    const cont = args.skip();
    if (!cont) unreachable;
    const action_arg = args.next() orelse {
        std.debug.print("No action provided\n", .{});
        return;
    };
    const action = Action.fromString(action_arg) orelse {
        std.debug.print("Unknown action\n", .{});
        return;
    };
    try toggleLight(action);
}

fn toggleLight(action: Action) !void {

    // Off
    const off_msg = comptime [_]u8{ 0x31, 0x00, 0x00, 0x14, 0x02, 0x00, 0x00, 0x00, 0xd0, 0x73, 0xd5, 0x30, 0x34, 0x45, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xa8, 0x0c, 0xc8, 0x00, 0x00, 0x00 };

    // On
    const on_msg = comptime [_]u8{ 0x31, 0x00, 0x00, 0x14, 0x02, 0x00, 0x00, 0x00, 0xd0, 0x73, 0xd5, 0x30, 0x34, 0x45, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xa8, 0x0c, 0xc8, 0x00, 0x00, 0x00 };

    const msg = switch (action) {
        .on => on_msg,
        .off => off_msg,
    };

    const client = try socket.Client.init("192.168.1.252", 56700);
    try client.connect();
    _ = try client.send(&msg);
}

fn stringEquals(one: []const u8, two: []const u8) bool {
    if (one.len != two.len) return false;
    for (one, two) |one_c, two_c| {
        if (one_c != two_c) return false;
    }
    return true;
}
